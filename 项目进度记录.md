# 双流条件注入BBDM线稿上色 - 项目进度记录

## 项目概述

**项目名称**：基于双流条件注入的像素域布朗桥线稿上色模型  
**开始日期**：2026年1月23日  
**预计周期**：5周  

---

## 一、总体规划

### 1.1 阶段划分

| 阶段 | 内容 | 预计时间 | 状态 |
|:---:|:---|:---:|:---:|
| **Phase 0** | 环境搭建与数据准备 | 1周 | 🔄 进行中 |
| **Phase 1** | A0 基准模型实现 | 3-4天 | ⬜ 未开始 |
| **Phase 2** | A1 参考图Cross-Attention | 3-4天 | ⬜ 未开始 |
| **Phase 3** | A2 边缘感知损失 | 1-2天 | ⬜ 未开始 |
| **Phase 4** | A3 TPS数据增强 | 1-2天 | ⬜ 未开始 |
| **Phase 5** | A4 对比实验 | 2天 | ⬜ 未开始 |
| **Phase 6** | 完整实验与论文撰写 | 1周 | ⬜ 未开始 |

**状态说明**：⬜ 未开始 | 🔄 进行中 | ✅ 已完成 | ❌ 阻塞

---

## 二、Phase 0：环境搭建与数据准备

### 2.1 任务清单

| 序号 | 任务 | 状态 | 完成日期 | 备注 |
|:---:|:---|:---:|:---:|:---|
| 0.1 | 确认BBDM原始代码可运行 | ⬜ | - | 运行Template-BBDM.yaml |
| 0.2 | 收集动漫彩图数据集 | ✅ | 2026-01-23 | 用户已准备 |
| 0.3 | 实现线稿提取pipeline | ✅ | 2026-01-23 | 用户已准备 |
| 0.4 | 构建数据集目录结构 | ✅ | 2026-01-23 | train/val/test |
| 0.5 | 编写AnimeColorizationDataset类 | ✅ | 2026-01-23 | 已注册到Registers |
| 0.6 | 修改Runner支持dict格式batch | ✅ | 2026-01-23 | _unpack_batch方法 |
| 0.7 | 验证DataLoader正确性 | ✅ | 2026-01-23 | 正确 |

### 2.2 数据集目录结构

```
dataset/
├── train/
│   ├── color/          # 彩色原图 (GT)
│   └── sketch/        # 提取的线稿
├── val/
│   ├── color/
│   └── sketch/
└── test/
    ├── color/
    └── sketch/
```

### 2.3 验收标准

- [ ] `python main.py --config configs/Template-BBDM.yaml --train` 可正常启动
- [ ] DataLoader输出shape正确：GT[B,3,256,256], lineart[B,1,256,256]
- [ ] 线稿提取质量可接受（边缘清晰，无过多噪声）

---

## 三、Phase 1：A0 基准模型实现

### 3.1 模型配置

**A0定义**：原始BBDM + 线稿Concat输入（无参考图，无边缘损失）

| 配置项 | 值 |
|:---|:---|
| 模型类型 | Pixel-space BBDM |
| UNet输入通道 | 4 (x_t:3 + lineart:1) |
| 条件注入 | 仅Concat（无Cross-Attention） |
| 损失函数 | L_diff (L1 loss) |
| 参考图 | ❌ 不使用 |

### 3.2 任务清单

| 序号 | 任务 | 状态 | 完成日期 | 备注 |
|:---:|:---|:---:|:---:|:---|
| 1.1 | 修改UNet in_channels=4 | ⬜ | - | openaimodel.py |
| 1.2 | 修改BrownianBridgeModel前向过程 | ⬜ | - | 支持concat lineart |
| 1.3 | 创建A0配置文件 | ⬜ | - | configs/A0-Baseline.yaml |
| 1.4 | 训练A0模型 | ⬜ | - | ~50 epochs |
| 1.5 | 评估A0指标 (FID, LPIPS, PSNR) | ⬜ | - | 记录基准 |
| 1.6 | 保存A0可视化结果 | ⬜ | - | 选10张典型样本 |

### 3.3 关键代码修改

**文件**：`model/BrownianBridge/BrownianBridgeModel.py`

```python
# 需修改的核心逻辑：
# 1. q_sample() 中 x_0 由 lineart.repeat(3) 得到
# 2. p_sample() 中 UNet输入为 concat(x_t, lineart)
```

### 3.4 验收标准

- [ ] A0模型训练收敛，loss稳定下降
- [ ] 生成结果具有基本的着色能力
- [ ] 记录基准指标：FID=___, LPIPS=___, PSNR=___

### 3.5 A0实验结果

| 指标 | 值 | 备注 |
|:---|:---:|:---|
| FID ↓ | - | |
| LPIPS ↓ | - | |
| PSNR ↑ | - | |
| SSIM ↑ | - | |
| 训练epoch | - | |
| 训练时长 | - | |

---

## 四、Phase 2：A1 参考图Cross-Attention

### 4.1 模型配置

**A1定义**：A0 + 参考图Cross-Attention注入

| 新增组件 | 说明 |
|:---|:---|
| ReferenceEncoder | 4层CNN，输出[B,256,16,16] |
| ColorCrossAttention | 插入UNet Middle Block |

### 4.2 任务清单

| 序号 | 任务 | 状态 | 完成日期 | 备注 |
|:---:|:---|:---:|:---:|:---|
| 2.1 | 实现ReferenceEncoder类 | ⬜ | - | 新建ref_encoder.py |
| 2.2 | 实现ColorCrossAttention类 | ⬜ | - | 或复用attention.py |
| 2.3 | 修改UNet添加Cross-Attention | ⬜ | - | Middle Block后 |
| 2.4 | 修改Dataset返回ref图像 | ⬜ | - | TPS变形暂不启用 |
| 2.5 | 创建A1配置文件 | ⬜ | - | configs/A1-CrossAttn.yaml |
| 2.6 | 训练A1模型 | ⬜ | - | |
| 2.7 | 评估A1指标并对比A0 | ⬜ | - | |

### 4.3 验收标准

- [ ] Cross-Attention正确注入，shape匹配
- [ ] 参考图颜色能有效迁移到生成结果
- [ ] A1指标优于A0

### 4.4 A1实验结果

| 指标 | A0 | A1 | 提升 |
|:---|:---:|:---:|:---:|
| FID ↓ | - | - | - |
| LPIPS ↓ | - | - | - |
| PSNR ↑ | - | - | - |
| SSIM ↑ | - | - | - |

---

## 五、Phase 3：A2 边缘感知损失

### 5.1 模型配置

**A2定义**：A1 + 边缘感知损失

| 新增组件 | 说明 |
|:---|:---|
| EdgeAwareLoss | 边缘区域2倍权重 |

### 5.2 任务清单

| 序号 | 任务 | 状态 | 完成日期 | 备注 |
|:---:|:---|:---:|:---:|:---|
| 3.1 | 实现EdgeAwareLoss类 | ⬜ | - | losses/edge_loss.py |
| 3.2 | 集成到训练损失计算 | ⬜ | - | λ_edge=1.0 |
| 3.3 | 创建A2配置文件 | ⬜ | - | configs/A2-EdgeLoss.yaml |
| 3.4 | 训练A2模型 | ⬜ | - | |
| 3.5 | 评估边缘保持度 (Edge IoU) | ⬜ | - | 新增指标 |
| 3.6 | 可视化边缘区域对比 | ⬜ | - | A1 vs A2 |

### 5.3 验收标准

- [ ] 边缘区域着色更清晰，溢色减少
- [ ] Edge IoU指标提升

### 5.4 A2实验结果

| 指标 | A1 | A2 | 提升 |
|:---|:---:|:---:|:---:|
| FID ↓ | - | - | - |
| LPIPS ↓ | - | - | - |
| Edge IoU ↑ | - | - | - |

---

## 六、Phase 4：A3 TPS数据增强

### 6.1 模型配置

**A3定义**：A2 + TPS变形增强（完整方案）

| 新增组件 | 说明 |
|:---|:---|
| TPSAugmentation | scale=0.2 |

### 6.2 任务清单

| 序号 | 任务 | 状态 | 完成日期 | 备注 |
|:---:|:---|:---:|:---:|:---|
| 4.1 | 实现TPS变形增强 | ⬜ | - | 使用kornia |
| 4.2 | 集成到Dataset | ⬜ | - | 仅训练时启用 |
| 4.3 | 创建A3配置文件 | ⬜ | - | configs/A3-Full.yaml |
| 4.4 | 训练A3模型 | ⬜ | - | 完整方案 |
| 4.5 | 评估跨姿态泛化能力 | ⬜ | - | 使用不同参考图测试 |

### 6.3 验收标准

- [ ] TPS变形正确应用，可视化验证
- [ ] 模型对参考图姿态差异更鲁棒

### 6.4 A3实验结果（完整方案）

| 指标 | A2 | A3 | 提升 |
|:---|:---:|:---:|:---:|
| FID ↓ | - | - | - |
| LPIPS ↓ | - | - | - |
| PSNR ↑ | - | - | - |
| SSIM ↑ | - | - | - |
| Edge IoU ↑ | - | - | - |

---

## 七、Phase 5：A4 对比实验

### 7.1 实验目的

**A4定义**：A3配置，但参考图改用Concat注入（替代Cross-Attention）

验证Cross-Attention相比Concat的优势。

### 7.2 任务清单

| 序号 | 任务 | 状态 | 完成日期 | 备注 |
|:---:|:---|:---:|:---:|:---|
| 5.1 | 修改UNet支持7通道输入 | ⬜ | - | x_t:3+L:1+R:3 |
| 5.2 | 创建A4配置文件 | ⬜ | - | configs/A4-RefConcat.yaml |
| 5.3 | 训练A4模型 | ⬜ | - | |
| 5.4 | 对比A3与A4结果 | ⬜ | - | 关键对比 |

### 7.3 A4 vs A3 对比

| 指标 | A3 (Cross-Attn) | A4 (Concat) | 结论 |
|:---|:---:|:---:|:---|
| FID ↓ | - | - | |
| LPIPS ↓ | - | - | |
| 颜色迁移准确性 | - | - | 主观评估 |
| 跨姿态鲁棒性 | - | - | 主观评估 |

---

## 八、消融实验汇总

### 8.1 完整消融结果

| 实验 | 配置 | FID↓ | LPIPS↓ | PSNR↑ | SSIM↑ | Edge IoU↑ |
|:---:|:---|:---:|:---:|:---:|:---:|:---:|
| A0 | Baseline (仅Concat) | - | - | - | - | - |
| A1 | +Cross-Attention | - | - | - | - | - |
| A2 | +EdgeLoss | - | - | - | - | - |
| A3 | +TPS (完整) | - | - | - | - | - |
| A4 | Concat注入对比 | - | - | - | - | - |

### 8.2 增量贡献分析

| 模块 | FID改进 | LPIPS改进 | 结论 |
|:---|:---:|:---:|:---|
| Cross-Attention (A1-A0) | - | - | |
| EdgeLoss (A2-A1) | - | - | |
| TPS增强 (A3-A2) | - | - | |

---

## 九、问题记录与解决方案

| 日期 | 问题描述 | 解决方案 | 状态 |
|:---|:---|:---|:---:|
| - | - | - | - |

---

## 十、里程碑检查点

| 里程碑 | 预计日期 | 实际日期 | 状态 |
|:---|:---:|:---:|:---:|
| 数据集准备完成 | - | - | ⬜ |
| A0基准模型完成 | - | - | ⬜ |
| A3完整方案完成 | - | - | ⬜ |
| 消融实验完成 | - | - | ⬜ |
| 论文初稿完成 | - | - | ⬜ |

---

## 十一、文件清单

### 11.1 配置文件

| 文件 | 对应实验 | 状态 |
|:---|:---:|:---:|
| configs/A0-Baseline.yaml | A0 | ⬜ |
| configs/A1-CrossAttn.yaml | A1 | ⬜ |
| configs/A2-EdgeLoss.yaml | A2 | ⬜ |
| configs/A3-Full.yaml | A3 | ⬜ |
| configs/A4-RefConcat.yaml | A4 | ⬜ |

### 11.2 代码文件

| 文件 | 功能 | 状态 |
|:---|:---|:---:|
| dataset/anime_colorization.py | 数据集类 | ⬜ |
| model/modules/ref_encoder.py | 参考图编码器 | ⬜ |
| model/modules/cross_attention.py | 交叉注意力 | ⬜ |
| model/losses/edge_loss.py | 边缘感知损失 | ⬜ |
| model/modules/tps_augment.py | TPS变形增强 | ⬜ |

---

*最后更新：2026年1月23日*
